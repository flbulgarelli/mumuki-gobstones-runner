<link href="./gs-element-blockly.html" rel="import" />
<link href="./gobstones-code-runner.html" rel="import" />

<dom-module id="mu-gobstones-custom-editor">
  <template>
    <gs-element-blockly id="blocklyElement"></gs-element-blockly>
    <gs-element-blockly id="blocklyTmp" style="visibility: hidden"></gs-element-blockly>
  </template>

  <script>
    Polymer({
      is: 'mu-gobstones-custom-editor',

      attached: function() {
        const setBlocklyColors = () => {
          if (typeof Blockly === 'undefined' || !Blockly.GOBSTONES_COLORS) return setTimeout(setBlocklyColors, 50);
          Blockly.HSV_SATURATION = 0.64;
          Blockly.HSV_VALUE = 1;

          Blockly.MUMUKI_COLORS = {
            pink: 346,
            blue: 204,
            yellow: 40
          };

          Blockly.Msg.MATH_HUE =                        Blockly.MUMUKI_COLORS.blue;
          Blockly.GOBSTONES_COLORS.literalExpression =  Blockly.MUMUKI_COLORS.blue;

          Blockly.GOBSTONES_COLORS.program =            Blockly.MUMUKI_COLORS.pink;
          Blockly.GOBSTONES_COLORS.interactiveProgram = Blockly.MUMUKI_COLORS.pink;
          Blockly.GOBSTONES_COLORS.interactiveBinding = Blockly.MUMUKI_COLORS.pink;

          Blockly.GOBSTONES_COLORS.controlStructure =   Blockly.MUMUKI_COLORS.yellow;
          Blockly.GOBSTONES_COLORS.primitiveCommand =   Blockly.MUMUKI_COLORS.yellow;
          Blockly.GOBSTONES_COLORS.complete =           Blockly.MUMUKI_COLORS.yellow;
          Blockly.GOBSTONES_COLORS.expression =         Blockly.MUMUKI_COLORS.yellow;
          Blockly.GOBSTONES_COLORS.assignation =        Blockly.MUMUKI_COLORS.yellow;

        }

        const updateFields = () => {
          const blockly = this.getBlockly();

          $("#mu-custom-editor-value")[0].value = blockly.generateCode({ withRegions: true, clearErrors: false });
          $("#mu-custom-editor-metadata")[0].value = blockly.workspaceXml;
          if (typeof angular !== 'undefined'){
            angular.element($("#mu-custom-editor-metadata")[0]).triggerHandler("change");
          }
        };

        const initialize = () => {
          setTimeout(() => {
            const blockly = this.getBlockly();

            if (!blockly || !blockly.workspace) return initialize();

            const teacherCode = this.getTeacherCode();
            if (teacherCode) {
              const actions = new Parser().getActionsFromSource(teacherCode);
              blockly.primitiveProcedures = actions.procedureDeclarations;
              blockly.primitiveFunctions = actions.functionDeclarations;
            }

            var metadata = $("#mu-custom-editor-metadata")[0].value;
            if (metadata) {
              blockly.workspaceXml = metadata;
            }

            blockly.workspace.addChangeListener(updateFields);
            updateFields();
          }, 50);
        };

        setBlocklyColors();
        initialize();
      },

      getBlockly: function() {
        return this.$.blocklyElement;
      },

      getStudentCode: function() {
        return $("#mu-custom-editor-value")[0].value || "";
      },

      getTeacherCode: function() {
        const xml = $("#mu-custom-editor-extra")[0].value || ""
        this.$.blocklyTmp.workspaceXml = xml;
        return this.$.blocklyTmp.generateCode();
      }
    });
  </script>
</dom-module>

<dom-module id="kids-submit-button">
  <template>
    <gobstones-code-runner></gobstones-code-runner>
  </template>

  <script>
    Polymer({
      is: 'kids-submit-button',
      listeners: {
        "gbs-run-request": "_onRunRequest"
      },

      ready: function() {
        const initialBoard = this._getTargetBoard();

        this.initialState = {
          size: initialBoard.size,
          table: initialBoard.table,
          header: initialBoard.header
        };
      },

      _onRunRequest: function(event) {
        const { detail: controller } = event;

        const editor = this._getEditor();
        const code = editor.getStudentCode();
        const teacherCode = editor.getTeacherCode();
        const finalBoard = this._getTargetBoard();

        this._clearErrors(finalBoard);

        // TODO: start XHR call to submit the solution

        controller.start({
          initialState: this.initialState,
          code: {
            main: code,
            library: "",
            teacher: teacherCode
          }
        }, {
          onResult: (state, fullState) => {
            const region = this._getLastRegion(fullState);
            if (region) this._highlight(region);

            this._updateBoard(state, finalBoard);
          },
          onCompilationError: (error) => {
            const { region } = error.on;
            if (region) this._showError(region, error);
          }
        });
      },

      _updateBoard: function(state, finalBoard) {
        const { error, table, head } = state;

        finalBoard.boom = error != null;

        if (error) {
          const region = this._getLastRegion(error.on);
          if (region) this._showError(region, error);
        } else {
          finalBoard.update(table, head);
        }
      },

      _highlight: function(region) {
        this._getBlockly().highlightBlock(region);
      },

      _showError: function(region, error) {
        this._getBlockly().showBlockError(region, error.message);
      },

      _clearErrors: function(finalBoard) {
        this._getBlockly().workspace.removeBlockErrors();
        finalBoard.boom = false;
      },

      _getLastRegion: function(context = {}) {
        const { regionStack } = context;
        return regionStack && regionStack.filter(it => it).slice(-1)[0];
      },

      _getBlockly: function() {
        return this._getEditor().getBlockly();
      },

      _getEditor: function() {
        return $("mu-gobstones-custom-editor")[0];
      },

      _getTargetBoard: function() {
        return $(".mu-kids-gbs-board-initial gs-board")[0];
      }
    });
  </script>
</dom-module>
