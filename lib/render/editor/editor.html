<link href="./gs-element-blockly.html" rel="import" />
<link href="./gobstones-code-runner.html" rel="import" />

<dom-module id="blockly-container">
  <template>
    <gs-element-blockly id="blocklyElement"></gs-element-blockly>
  </template>

  <script>
    Polymer({
      is: 'blockly-container',
      ready: function() {
        const initialize = () => {
          setTimeout(() => {
            if (!this.$.blocklyElement || !this.$.blocklyElement.workspace) return initialize();

            var metadata = $("#mu-custom-editor-metadata")[0].value;
            if (metadata) {
              this.$.blocklyElement.workspaceXml = metadata;
            }

            const updateFields = () => {
              $("#mu-custom-editor-value")[0].value = this.$.blocklyElement.generateCode();
              $("#mu-custom-editor-metadata")[0].value = this.$.blocklyElement.workspaceXml;
            };

            this.$.blocklyElement.workspace.addChangeListener(updateFields);
            updateFields();
          }, 50);
        };

        initialize();
      }
    });
  </script>
</dom-module>

<dom-module id="kids-submit-button">
  <template>
    <gobstones-code-runner></gobstones-code-runner>
  </template>

  <script>
    Polymer({
      is: 'kids-submit-button',
      listeners: {
        "gbs-run-request": "_onRunRequest"
      },
      _onRunRequest: function(event) {
        const { detail: controller } = event;

        const code = $("#mu-custom-editor-value")[0].value;
        const initialBoard = $(".gbs-initial-state")[0];
        const finalBoard = $(".gbs-final-state")[0];

        controller.start({
          initialState: {
            size: initialBoard.size,
            table: initialBoard.table,
            header: initialBoard.header
          },
          code: {
            main: code,
            library: "", // TODO: Support library
            teacher: "" // TODO: Support teacher library
          }
        }, {
          onResult: ({ table, head }) => {
            finalBoard.update(table, head);
          }
        });
      }
    });
  </script>
</dom-module>
