<link href="./gs-element-blockly.html" rel="import" />
<link href="./gobstones-code-runner.html" rel="import" />

<dom-module id="blockly-container">
  <template>
    <gs-element-blockly id="blocklyElement"></gs-element-blockly>
  </template>

  <script>
    Polymer({
      is: 'blockly-container',

      ready: function() {
        const initialize = () => {
          setTimeout(() => {
            if (!this.$.blocklyElement || !this.$.blocklyElement.workspace) return initialize();

            var metadata = $("#mu-custom-editor-metadata")[0].value;
            if (metadata) {
              this.$.blocklyElement.workspaceXml = metadata;
            }

            const updateFields = () => {
              $("#mu-custom-editor-value")[0].value = this.$.blocklyElement.generateCode({ withRegions: true, clearErrors: false });
              $("#mu-custom-editor-metadata")[0].value = this.$.blocklyElement.workspaceXml;
            };

            this.$.blocklyElement.workspace.addChangeListener(updateFields);
            updateFields();
          }, 50);
        };

        initialize();
      }
    });
  </script>
</dom-module>

<dom-module id="kids-submit-button">
  <template>
    <gobstones-code-runner></gobstones-code-runner>
  </template>

  <script>
    Polymer({
      is: 'kids-submit-button',
      listeners: {
        "gbs-run-request": "_onRunRequest"
      },

      _onRunRequest: function(event) {
        const { detail: controller } = event;

        const code = $("#mu-custom-editor-value")[0].value || "";
        const extraCode = $("#mu-custom-editor-extra")[0].value || "";
        const blockly = $("gs-element-blockly")[0];
        const initialBoard = $(".mu-kids-gbs-board-initial gs-board")[0];
        const finalBoard = $(".mu-kids-gbs-board-final gs-board")[0];

        this._clearErrors(blockly, finalBoard);

        controller.start({
          initialState: {
            size: initialBoard.size,
            table: initialBoard.table,
            header: initialBoard.header
          },
          code: {
            main: code,
            library: "",
            teacher: extraCode
          }
        }, {
          onResult: (state, fullState) => {
            const region = this._getLastRegion(fullState);
            if (region) blockly.highlightBlock(region);

            this._updateBoard(state, finalBoard, blockly);
          }
        });
      },

      _updateBoard: function(state, finalBoard, blockly) {
        const { error, table, head } = state;

        finalBoard.boom = error != null;

        if (error) {
          const region = this._getLastRegion(error.on);
          if (region) blockly.showBlockError(region, error.message);
        } else {
          finalBoard.update(table, head);
        }
      },

      _clearErrors: function(blockly, finalBoard) {
        blockly.workspace.removeBlockErrors();
        finalBoard.boom = false;
      },

      _getLastRegion: function(context = {}) {
        const { regionStack } = context;
        return regionStack && regionStack.filter(it => it).slice(-1)[0];
      }
    });
  </script>
</dom-module>
